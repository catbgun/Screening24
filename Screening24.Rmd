---
title: "Screening24"
output: pdf_document
date: "2025-05-08"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
*Functions* 
The following function will replace all "<LOD"
- har det no ÃƒÂ¥ si om det er mellomrm mellom < og tallet? nei, tror ikke det
```{r}
#function to recognize "<LOD" and to replace with 0.5*LOD. The next step is to use this only for combinations of sample type and site with LOD >30
dLimity <- function(v){
  v <- as.character(v)
  isLimit <- grepl("<", v)  #grepl() is a built-in R function looks for a smaller string of characters
  v[isLimit] <- as.numeric(gsub("<(.*)", "\\1", v[isLimit]))/2 #gsub(pattern, replacement, x) for substitution
  as.numeric(v)
}

#Test to set desired number of digits
sigfig <- function(vec, digits){
  return(gsub("\\.$", "", formatC(signif(vec,digits=digits), digits=digits, format="fg", flag="#")))
}
```

```{r, results=FALSE, message=FALSE, warning=FALSE}
#install.packages(c("dplyr", "ggplot2", "plyr", "Rmisc", "tidyverse", "lubridate", "stringr"))
Packages <- c("plyr", "dplyr", "ggplot2",  "tidyr", "egg", "reshape2", "forcats", "RColorBrewer")
lapply(Packages, library, character.only = TRUE)
#trengs disse? "Rmisc", "tidyverse", "lubridate", "stringr",
```

#Load file
```{r echo = T, results = 'hide'}
Sys.setlocale(locale="no_NO")

#df24 <- read.table("Scre24_R_data fra Malcolm.txt", skip=0, header=TRUE, sep="\t", na.string=c(""))
df24 <- read.table("Scre24_R_data fra Malcolm_03.txt", skip=0, header=TRUE, sep="\t", na.string=c(""))
```

## Summary table for appendix
## Sumamry table

```{r create summary table}
library(dplyr)
#library(rbind)

dx_sum <- select(df24, "Station", "Diflubenzuron", "Cu", "sUVa_m", "THg_m", "THGTOC_m")

inl %>% count(THg_m)

sum <- df24 %>% 
  group_by(Matrix) %>% 
  summarise(across(.cols  = where(is.numeric), .f = list(mean = mean, min = min, max = max, sd = sd), na.rm = TRUE))
  



sum_n <- dx_sum %>% 
  group_by(Station) %>% 
  length(across(.cols  = where(is.numeric)))

write.csv(sum, "summary monitoingX.csv")

```


#From wide to long data format
```{r from wide to long}
df24_long <- gather(df24, compound, value, Diflubenzuron:Cu, factor_key=TRUE)
#df23_longg <- subset(df23_long, !is.na(value)) #usikker om denne tar bort alle versjoner av na

#Ta bort service stasjonen
#df24_longx <- subset(df24_long, !Stasjonskode =="D")
#df24_longD <- subset(df24_long, Stasjonskode =="D")
```

#Make summary table count - number of samples per sample type and compound
```{r}
#count <- df24 %>% count(KOMPONENT, Sample.type)
#print(unique(df24_long$compound))

df24_longx <- subset(df24_long, compound != "Hexaflu")

#add grouping
df24_long = df24_longx%>%
  mutate(Group = case_when(#compound %in% c("Cu", "Zn") ~ "Metals", #skal vi ikke ha med de andre metallene?
                           compound %in% c("Diflubenzuron", "Teflubenzuron", "Emamectin") ~ "Delousing agents",
                                compound %in% c("TFA", "BCCPCA", "TR1", "CHFPCN", "CCPCA", "CDHFPCN", "TR2", "TR3", "TR4", "CFPCN", "TR5") ~ "Tralopyril - Associated compounds",
                           compound %in% c("Tralopyril", "CuPT", "Cu", "Zn") ~ "Antifouling agents"))



#df24x <- subset(df24x, KOMPONENT != "Grunnpris")
```

```{r Detection frequency}
#remove n.a due to limited sample material. SHould not be included in calculations
#df24y <- subset(df24x, RESULTAT != "n.a.")

df24y_freq = df24_long %>%
  group_by(compound, Matrix) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))), 
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

```


```{r Avoid plotting average of those with only < LOD}

df24z_freq <- df24y_freq %>% 
  mutate(plotting = ifelse(det_frac == 0, 
                           "<LOD", 
                           value))

# claculate 0.5xLOD 
#df24z_filt_X <- cbind(df24z_freq[,c(1:18)], apply(df24z_freq[,19, drop=F],2, dLimity))
df24z_filt_X <- cbind(df24z_freq[,c(1:20)], apply(df24z_freq[,21, drop=F],2, dLimity))

```

Calculate mean
- sjekk at ble riktig! ta ut excel f eks
```{r}
df24z_finalx = df24z_filt_X  %>%
  group_by(compound, Matrix) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

```

##geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 2))), color = "white", size = 5)+
#geom_text(aes(label=ifelse(is.na(meanx), "", round(meanx, digits=3))), color = "white", size = 5)

Set order of substances in plot
```{r}
df24z_finalx$compound <- as.character(df24z_finalx$compound)
df24z_finalx$Group <- as.character(df24z_finalx$Group)
```


```{r}
#to get "s" for suspect and "n.a." for not available
df24z_finalxy <- df24z_finalx %>% 
  mutate(meanxyz = ifelse(compound == "CHFPCN" |
                            compound == "CFPCN"|
                            compound == "CDHFPCN" |
                            compound == "TR1" |
                            compound == "TR2" |
                            compound == "TR3" |
                            compound == "TR4" |
                            compound=="TR5",
                           "S", 
                           " "))

```

### All together
```{r }

df24z_finalxy$compound <- revalue(df24z_finalxy$compound, c("CuPT" = "Copper/Zinc pyrithione", "Emamectin" ="Emamectin benzoate"))

#set order of dample kcompounds
df24z_finalxy <- df24z_finalxy %>% 
  mutate(Sample.type = factor(Matrix, levels = c("Water", "Sediment", "Benthic animals", "Fish_gills", "Fish_liver")))

#set order of sample compounds
df24z_finalxyz <- df24z_finalxy %>% 
  mutate(compound = factor(compound, levels = c("Copper/Zinc pyrithione", "Cu", "Zn", "Tralopyril", 
    "BCCPCA", "CCPCA", "CHFPCN", "CDHFPCN", "TR1", "TR2", "TR3", "TR4", "TR5", "CFPCN", "TFA", 
    "Emamectin benzoate", "Diflubenzuron", "Teflubenzuron")))

#set order of sample kcompounds
df24z_finalxyzz <- df24z_finalxyz %>% 
  mutate(Group = factor(Group, levels = c("Antifouling agents", "Tralopyril - Associated compounds", "Delousing agents")))

#Change names of matrices
df24z_finalxyzz$Matrix <- revalue(df24z_finalxyzz$Matrix, c("Water" = "Seawater (ng/L)", "Sediment" = "Sediment (ng/g, d.w.)", "Benthic animals" ="Benthic animals (ng/g, w.w.)", "Fish_liver" ="Fish liver (ng/g, w.w.)", "Fish_gills" ="Fish gill (ng/g, w.w.)"))

#set order of matrices
df24z_finalxyzz1 <- df24z_finalxyzz %>% 
  mutate(Matrix = factor(Matrix, levels = c("Seawater (ng/L)", "Sediment (ng/g, d.w.)", "Benthic animals (ng/g, w.w.)", "Fish gill (ng/g, w.w.)", "Fish liver (ng/g, w.w.)")))

```

 
```{r }
#Fjern alle < LOD
#wwt3 <- subset(wwt2, meanx != "NaN") 
#df24z_finalxyzzz <- subset(df24z_finalxyzz1, det_frac != 0) 
df24z_finalx

#Remove benthic animal metal values to make white in plot
df24z_finalxyzz3 <- df24z_finalxyzz1[!(df24z_finalxyzz1$Matrix == "Benthic animals (ng/g, w.w.)" & df24z_finalxyzz1$compound %in% c("Cu", "Zn")),] 

df24z_finalxyzz3$det_frac[df24z_finalxyzz3$det_frac == 0] <- NA

wwt_long2 <- ggplot(df24z_finalxyzz3, aes(x=Matrix, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  #geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)
  geom_text(aes(label= ifelse(meanxyz=="S", meanxyz, ifelse(is.na(meanx), " ", as.numeric(sigfig(meanx, 1))))), color = "white", size = 5)+
  scale_fill_steps2(low = "#B9E8FF", 
                    mid = "#50C5FF", 
                    high = "#134e95",
                    midpoint = 50,
                    breaks=c(0, 25, 50,75, 100), limits=c(0.5,100), na.value = "lightgrey")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 0.96),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=12), 
        strip.text.y = element_text(angle = 0, size=12)) +
  ggtitle("") + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~., scales="free", space="free_y", labeller = label_wrap_gen(width=2))


#ggplot(df24z_finalxyzz3, aes(x=Matrix, y=fct_rev(compound), fill=det_frac)) +
#  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
#  #geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)
#  geom_text(aes(label= ifelse(meanxyz=="S", meanxyz, ifelse(is.na(meanx), " ", as.numeric(sigfig(meanx, 1))))), color #= "white", size = 5)+
# scale_fill_gradient2(low = "#74C476", 
#                       mid = "orange", 
#                       high = "red",
#                       midpoint = 50,
#                       breaks=c(0,50,100), limits=c(0.5,100), na.value = "lightgrey")+  # determine the colour
#   theme(panel.grid.major.x=element_blank(), #no gridlines
#        panel.grid.minor.x=element_blank(), 
#        panel.grid.major.y=element_blank(), 
#        panel.grid.minor.y=element_blank(),
#        panel.background=element_rect(fill="white"), # background=white
#        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
#        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
#        axis.text.y = element_text(size = 12, colour="black"),
#        legend.text=element_text(size=13),
#        axis.line.x = element_line(color="black", linewidth = 1),
#        axis.line.y = element_line(color="black", linewidth = 1),
#        axis.ticks = element_line(color="black", linewidth=1),
#        legend.position =c(0.85, 0.96),
#        legend.direction = "horizontal",
#        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
#        legend.margin=margin(0,0,0,0),
#        legend.box.margin=margin(10,10,140,10),
#        strip.text.x = element_text(size = 15),
#        panel.spacing.x = unit(0.2, "lines"),
#        legend.title=element_text(size=12), 
#        strip.text.y = element_text(angle = 0, size=12)) +
#  ggtitle("") + 
#  scale_x_discrete(name="") +
#  scale_y_discrete(name="") +
#  labs(fill="Detection frequency (%)")+
#  facet_grid(Group~., scales="free", space="free_y", labeller = label_wrap_gen(width=2))


ggsave("WW_t2.png", wwt_long2, width = 9, height = 9)

```







Boxplot Tralopyril distance
```{r}
sedT <- subset(df24z_finalxyzz3, compound == "Tralopyril" & Matrix == "Sediment (ng/g, d.w.)")
sedTT <- subset(sedT, !Stasjonskode == "D")

sedTT$plotting <- as.numeric(sedTT$plotting)
sedTT$value <- as.numeric(sedTT$value)
sedT$Distance.to.cage <- as.numeric(sedT$Distance.to.cage)
typeof(sedT$value)

#add grouping
sedTTx = sedTT%>%
  mutate(Groupx = case_when(Stasjonsnummer %in% c("1") ~ "1",
                            Stasjonsnummer %in% c("3") ~ "3",
                           Stasjonsnummer %in% c("4", "5", "6") ~ "4-6",
                           Stasjonsnummer %in% c("2", "6_ref")~ "2 and ref."))

ggplot(sedTTx, aes(y=value,  fill=as.factor(Groupx)))+
  geom_boxplot(aes(fill=Groupx))

```




## Correlation plots, please
Tralopyril and degradation products ++
```{r}
library("ggpubr")
head(df24)

sedi <- subset(df24, Matrix == "Sediment")

as.numericclass(sedi$Tralopyril)
as.numeric
class(sedi$CHFPCN)
  
#IMPORTANT!!! Correlation plot for biodeg and parameters
ggplot(sedi, aes(as.numeric(Tralopyril), as.numeric(CFPCN)))+
  geom_point(aes(colour=interaction(factor(Stasjonskode))), size=6)+
    scale_y_log10()+
  scale_x_log10()+
  theme_bw()+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  stat_regline_equation(label.x=0.35, label.y=2.15, size=5) +
  stat_cor(aes(label=..rr.label..), label.x=0.35, label.y=2.4, size=5)+
  #stat_cor(method = "pearson", label.x = 0.30, label.y = 2, size=5)+
  theme(axis.text.y = element_text(size= 18),
        axis.title.x = element_text(size = 22, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 22, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 18),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=22),
        legend.title = element_blank())+
  labs(title = "", x = "Tralopyril (ng/g)", y = "CFPCN (instrument signal)")


ylim(0, -0.007)+
  scale_colour_manual(values=c("#F8766D", "#7CAE00", "#00BFC4"))+
  xlim(0, 8)
```

#for Haver_, create one with mol/L tralopyril and TFA
Tralopyril Mw: 349,53 g/mol
TFA Mw: 114,02 g/mol
nano: 1 000 000 000
```{r Tralopyril~TFA molar}
sedi$tralopyril2 <- (as.numeric(sedi$Tralopyril))/349.53 #nmol/L
sedi$TFA2 <- (as.numeric(sedi$TFA))/114.02 #nmol/L

sedi$tralopyril3 <- ((as.numeric(sedi$Tralopyril)/1000000000)/349.53)*1000000000 #nmol/L
sedi$TFA3 <- ((as.numeric(sedi$TFA)/1000000000)/114.02)*1000000000 #nmol/L

sedi2 <- subset(sedi, Stasjonskode != "D")

ggplot(sedi, aes(as.numeric(tralopyril2), as.numeric(TFA2)))+
  geom_point(aes(colour=interaction(factor(Stasjonskode))), size=6)+
  scale_y_log10()+
  scale_x_log10()+
  theme_bw()+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  stat_regline_equation(label.x=log(0.2), label.y=0.5, size=5) +
  stat_cor(aes(label=..rr.label..), label.x=log(0.2), label.y=0.7, size=5)+
  #stat_cor(method = "pearson", label.x = 0.30, label.y = 2, size=5)+
  theme(axis.text.y = element_text(size= 18),
        axis.title.x = element_text(size = 22, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 22, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 18),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=22),
        legend.title = element_blank())+
  labs(title = "", x = "Tralopyril (nmol/g)", y = "TFA (nmol/g)")
```




## Look at relationships with depth and distance from cage
```{r}
sedi <- subset(df24, Matrix == "Sediment")
RColorBrewer::display.brewer.all()

ggplot(sedi, aes(as.numeric(Depth), as.numeric(Tralopyril)))+
  geom_point(aes(colour=interaction(factor(Stasjonskode))), size=6)+
  scale_y_log10()+
  scale_x_log10()+
  theme_bw()+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  stat_regline_equation(label.x=1.5, label.y=5.8, size=5) +
  stat_cor(aes(label=..rr.label..), label.x=1.5, label.y=5.6, size=5)+
  #stat_cor(method = "pearson", label.x = 0.30, label.y = 2, size=5)+
  theme(axis.text.y = element_text(size= 18),
        axis.title.x = element_text(size = 22, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 22, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 18),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=22),
        legend.title = element_blank())+
  labs(title = "", x = "Ocean depth (m)", y = "Tralopyril (ng/g)")+
  scale_color_brewer(palette = "RdYlGn")
  scale_fill_brewer(palette = "Set2")

```

#look for site specific patterns in other than tralopyril
```{r}
sedi <- subset(df24, Matrix == "Sediment")
RColorBrewer::display.brewer.all()

sedi2 <- subset(sedi, !Stasjonskode=="D")
nedi <- subset(sedi2, Stasjonskode %in% c("B", "C", "D"))

forst <- subset(sedi2, Stasjonsnummer == "1")

ggplot(sedi2, aes(as.numeric(Distance.to.cage), as.numeric(CHFPCN)))+
  geom_point(aes(colour=interaction(factor(Stasjonskode))), size=6)+
  #scale_y_log10()+
  #scale_x_log10()+
  theme_bw()+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  #stat_regline_equation(label.x=1.5, label.y=5.8, size=5) +
  stat_cor(aes(label=..rr.label..), label.x=1.5, label.y=5.6, size=5)+
  #stat_cor(method = "pearson", label.x = 0.30, label.y = 2, size=5)+
  theme(axis.text.y = element_text(size= 18),
        axis.title.x = element_text(size = 22, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 22, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 18),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=22),
        legend.title = element_blank())+
  labs(title = "", x = "Distance (m)")+
  #scale_color_brewer(palette = "RdYlGn")+
  facet_grid(Stasjonskode~., scales="free")

ggplot(nedi, aes(as.numeric(Distance.to.cage), as.numeric(Tralopyril), fill=Stasjonsnummer))+
  geom_boxplot(aes(colour=interaction(factor(Stasjonsnummer))), size=6)+
  scale_y_log10()+
  scale_x_log10()+
  theme_bw()+
  #geom_smooth(method = "lm", se = FALSE, colour="black")+
  #stat_regline_equation(label.x=1.5, label.y=5.8, size=5) +
  #stat_cor(aes(label=..rr.label..), label.x=1.5, label.y=5.6, size=5)+
  #stat_cor(method = "pearson", label.x = 0.30, label.y = 2, size=5)+
  theme(axis.text.y = element_text(size= 18),
        axis.title.x = element_text(size = 22, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 22, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 18),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=22),
        legend.title = element_blank())+
  labs(title = "", x = "Distance (m)")
  #scale_color_brewer(palette = "RdYlGn")
  facet_grid(Stasjonskode~., scales="free")


```






##Antifouling agents
- distance from site
- sum of degradation products and traloporyl
```{r}
#scatterplot
tr <







#Tralopyril distance from fishfarm and different matrics
tr <- subset(df24z_finalxy, KOMPONENT == "Tralopyril" & Sample.type %in% c("Seawater", "Sediment", "Benthic animals"))

tr2 <- subset(df24z_finalxy, Level %in% c("Antifouling agents", "Degradation products - Tralopyril") & Sample.type %in% c("Seawater", "Sediment", "Benthic animals"))

tr2x <- subset(tr2, !KOMPONENT %in% c("Copper pyrithione", "Zinc pyrithione", "Copper", "Zinc"))

#add grouping
tr2y = tr2x %>%
  mutate(Pot = case_when(Level %in% c("Antifouling agents") ~ "Original",
                           Level %in% c("Degradation products - Tralopyril") ~ "Degradation"))

    
#fill = interaction(Subcategory, Group))

library(dplyr)
library(stringr)
tr2z=tr2y %>% 
  mutate(x_label = factor(str_replace(interaction(Pot, KOMPONENT), '\\.', ' / '),
                          ordered=TRUE))

ggplot(df, aes(x=x_label, y=total, fill=type)) +
  geom_bar(stat='identity') +
  labs(x='Year / Treatment')


tr2zz = tr2z  %>%
  group_by(KOMPONENT, Sample.type, Plass) %>%
  mutate(meanx2 = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#set order of dample kcompounds
tr2zzz <- tr2zz %>% 
  mutate(Pot = factor(Pot, levels = c("Original", "Degradation")))


ggplot(tr2zzz, aes(x=as.factor(Pot), y=as.numeric(meanx2)+1, fill= forcats::fct_rev(KOMPONENT)))+
  #geom_point()+
  geom_bar(stat="identity", position="stack")+
  #geom_col( width=0.8, position=position_dodge())+
  #geom_bar(stat="identity", position = position_dodge())+
  scale_y_continuous(trans='log10')+
  #geom_dotplot(binaxis='y', stackdir='center')
  facet_grid(Sample.type~Plass, scales="free")

#in Tralopyril, look for effects from station. Is there higher in Mørenot?
ggplot(tr, aes(x=as.factor(Plass), y=as.numeric(plotting), fill=Lokasjon, colour=Lokasjon))+
  geom_point(size=3)+
  scale_y_continuous(trans='log10')+
  #geom_dotplot(binaxis='y', stackdir='center')
  facet_grid(Sample.type~., scales="free")
  ylim(0, 100)
  
#tralopyril with depth - only in sediment
t_sed <- subset(tr, Sample.type =="Sediment")  

ggplot(t_sed, aes(x=as.numeric(Havdyp), y=as.numeric(plotting), fill=Lokasjon, colour=Lokasjon))+
  geom_point(size=3)+
  scale_y_continuous(trans='log10')
  #geom_dotplot(binaxis='y', stackdir='center')
  facet_grid(Sample.type~., scales="free")
  ylim(0, 100)

```

#Looking at Cu and Zn
```{r}
met_Cu <- subset(tr2, KOMPONENT %in% c("Copper"))
met_Zn <- subset(tr2, KOMPONENT %in% c("Zinc"))


#in Cu and Zn, look for effects from station. Is there higher in Mørenot?
ggplot(met_Zn, aes(x=as.factor(Plass), y=as.numeric(plotting), fill=Lokasjon, colour=Lokasjon))+
  geom_point(size=3)+
  scale_y_continuous(trans='log10')+
  #geom_dotplot(binaxis='y', stackdir='center')
  facet_grid(Sample.type~., scales="free")
  ylim(0, 100)

```

## PNEC figure
The following compounds have values available: 
Tralopyril, BCCPA, CCPCA, CHFPCN, TFA, Zn, Cu, Diflubenzuron, Teflubenzuron, Emamectin benzoate
```{r}
library(magrittr)
newtablexx <- subset(df24z_finalxyzz3, value != "n.a.")
#følgende gjør om alle "< LOD" observasjoner til NA slik at de ikke inkluderes som minimumsverdi
newtablexx$value <- as.numeric(newtablexx$value)
newtablexxx <- newtablexx %>% drop_na(value)

pnec <- subset(newtablexxx, compound %in% c("Tralopyril", "BCCPCA", "CCPCA", "TFA", "Cu", "Zn", "Diflubenzuron", "Teflubenzuron", "Emamectin benzoate"))

pnec3 <- pnec%>%
  mutate(sample_category = case_when
         (Sample.type %in% c("Water") ~ "Seawater",
          Sample.type %in% c("Sediment") ~ "Sediment"))
          #Sample.type %in% c("Blubber", "Blue mussel", "Liver", "Muscle") ~ "Biota_marine_fish"))

#remove service station, stasjonskode D
pnec3x <- subset(pnec3, !Stasjonskode =="D")
pnec3D <- subset(pnec3, Stasjonskode =="D")


#filter out max an min values for each category. Wich categories to choose? 
pnec_max_minx <- pnec3D %>%
  group_by(compound, sample_category) %>% #bruk noe annet enn treatment. Må tilpasses pnec kategorier. lage nye
  mutate(Min = min(value), Max = max(value))


#Make new categories to match the PNEC categories of freswater, sediment og biota
#not using air values here
#pnec_max_miny <- subset(pnec_max_minx, !Medium_id2=="Air")

#Laste opp fil med PNEC verdier. Laget fra info i word
#condition and sample category
# short and compound
dx <- read.table("PNECs_Screening24.txt", header=TRUE, sep="\t", na.string=c(""))

#Calculate to the correct abbreviations
#dx$Freshwater <- dx$Freshwater *1000
#dx$Sediment2 <- dx$Sediment *1
#dx$Biota2 <- dx$Biota*1

#delete those missing for all categories
#dxx <- dx[ -c(6) ]
#x <- dxx[rowSums(is.na(dxx[,4:6]))!=3,]

dx_long <- gather(dx, sample_category, limit, Seawater:Sediment, factor_key=TRUE)

#one may have wrong class
#pnec_max_min4 <- as.data.frame(pnec_max_min2)
#subsetting to keep only those with match
#pnec_max_min4$sample_category <- revalue(pnec_max_min4$sample_category, c("Freshwater"="Freshwater2"))

#pnec_max_min5 <- subset(pnec_max_min4, sample_category%in% c("Freshwater2", "Sediment2", "Biota2"))



#MERGE. Til pnec_max_min2 skal vi fra dx legge til alle kolonner ved å matche 
dx2 <- merge(x=pnec_max_minx,y=dx_long, by=c(as.character("compound"), as.character("sample_category")),
             all.x=TRUE)

nrow(pnec_max_minx)
#substances to be excluded
#dx2x <- subset(dx2, !compound %in% c("BHPMEBD", "DMPTDPP", "DMPTTPP", "Sus62", "SYLKL", "SEROLD", "DIUDP", "EMOPCC", #"CTCVB", "DCTCVB", "DCTCVB", "TCTDT", "ETTSDD", "MPSHDOSD", "HOTMIKA", "Fett"))

#ARE THRER wrong abbreviations for pnec??



```

```{r Cleaning up before plotting}
#remove duplicate rows before plotting
dx3 <-dx2 %>% 
  distinct(Min, Max, compound, sample_category, .keep_all = TRUE)

#remove those not fitting into the pnec categories
dx4 <- dx3[!is.na(dx3$sample_category),]
dx5 <- dx4[!is.na(dx4$limit),]
unique(dx4$compound)

#write.csv(dx5, "C:/Users/CBG/OneDrive - NIVA/1 #Projects/Screening/Screening_R/Screening/Output/240826_TEST_pnec_2.csv", row.names=FALSE)

```

```{r PNEC plot}
#dx5 <- as.numeric(dx5$limit)
#rfe <- subset(dx5, group=="PBDE")
#dx5$Group <- revalue(dx5$Group, c("UV Stabilizer"="UV"))
#kug <- subset(dx5, Group == "Other")

#remove service station
#dx5x <- subset(dx5, !Stasjonskode =="D")


ggplot(dx5, aes(y=fct_rev(compound), x=value, xmin = Min, xmax=Max, colour = sample_category))+ 
  geom_linerange(aes(colour = sample_category, alpha=1), linewidth=2.5, position = position_dodge2(width = 0.7))+
  geom_point(aes(x=(limit), fill = sample_category),  size=6, shape=18, position = position_dodge2(width = 0.7))+
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1,vjust=1,size = 15,colour="black"),
        axis.text.y = element_text(size = 15,colour="black"),
        axis.title.y = element_blank(),
        axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0), size=17),
        panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text.y = element_text(size = 16, angle = 0, hjust=0),
        legend.title = element_blank(),
        legend.text = element_text(size=18),
        plot.margin = margin(0.8, 0.15, 1.2, 0.15, "cm"),
        legend.position = "top")+
  facet_grid(Group~., scales="free_y", space='free')+
  scale_x_continuous(trans='log10') +  
  xlab("log10(concentration)")+
  scale_alpha(guide = 'none')+
  guides(color=guide_legend("sample_category"), fill = "none")+
  scale_color_manual(values = c("deepskyblue2", "tan4"),
  labels = c('Seawater', 'Sediment'))
  


ggsave("pnec23.png", pnecopp, width = 10, height = 18)

#, values = c("red", "blue", "grey"))
#  scale_colour_manual(labels = c("Biota", "Freshwater", "Sediment"), values = c("red", "blue", "grey"))
  
  #scale_fill_manual(values = c("red", "blue", "grey"))
  #scale_colour_manual(values = c("red", "blue", "grey"))


```















### Fra 2023!!!


```{r Making the PNEC Figure}


pnec3 <- pnec%>%
  mutate(sample_category = case_when
         (Sample.type %in% c("Water, filtered") ~ "Freshwater",
          Sample.type %in% c("Sludge", "Soil", "Sediment") ~ "Sediment",
          Sample.type %in% c("Blubber", "Blue mussel", "Liver", "Muscle") ~ "Biota_marine_fish"))

#filter out max an min values for each category. Wich categories to choose? 
pnec_max_minx <- pnec3 %>%
  group_by(compound, sample_category) %>% #bruk noe annet enn treatment. Må tilpasses pnec kategorier. lage nye
  mutate(Min = min(value), Max = max(value))


#Make new categories to match the PNEC categories of freswater, sediment og biota
#not using air values here
#pnec_max_miny <- subset(pnec_max_minx, !Medium_id2=="Air")

#Laste opp fil med PNEC verdier. Laget fra info i word
#condition and sample category
# short and compound
dx <- read.table("PNECs Screening 23_v2.txt", header=TRUE, sep="\t", na.string=c(""))
dx$compound <- revalue(dx$compound, c("DMPSHEN"="OTNE"))

#Calculate to the correct abbreviations
dx$Freshwater <- dx$Freshwater *1000
#dx$Sediment2 <- dx$Sediment *1
#dx$Biota2 <- dx$Biota*1

#delete those missing for all categories
dxx <- dx[ -c(6) ]
x <- dxx[rowSums(is.na(dxx[,4:6]))!=3,]

dx_long <- gather(x, sample_category, limit, Freshwater:Biota_marine_fish, factor_key=TRUE)

#one may have wrong class
#pnec_max_min4 <- as.data.frame(pnec_max_min2)
#subsetting to keep only those with match
#pnec_max_min4$sample_category <- revalue(pnec_max_min4$sample_category, c("Freshwater"="Freshwater2"))

#pnec_max_min5 <- subset(pnec_max_min4, sample_category%in% c("Freshwater2", "Sediment2", "Biota2"))



#MERGE. Til pnec_max_min2 skal vi fra dx legge til alle kolonner ved å matche 
dx2 <- merge(x=pnec_max_minx,y=dx_long, by=c(as.character("compound"), as.character("sample_category")),
             all.x=TRUE)

nrow(pnec_max_minx)
#substances to be excluded
dx2x <- subset(dx2, !compound %in% c("BHPMEBD", "DMPTDPP", "DMPTTPP", "Sus62", "SYLKL", "SEROLD", "DIUDP", "EMOPCC", "CTCVB", "DCTCVB", "DCTCVB", "TCTDT", "ETTSDD", "MPSHDOSD", "HOTMIKA", "Fett"))

#ARE THRER wrong abbreviations for pnec??

write.csv(dx2x, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/240826_TEST_pnec.csv", row.names=FALSE)
```

```{r Cleaning up before plotting}
#remove duplicate rows before plotting
dx3 <-dx2x %>% 
  distinct(Min, Max, compound, sample_category, .keep_all = TRUE)

#remove those not fitting into the pnec categories
dx4 <- dx3[!is.na(dx3$sample_category),]
dx5 <- dx4[!is.na(dx4$limit),]
unique(dx4$compound)

write.csv(dx5, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/240826_TEST_pnec_2.csv", row.names=FALSE)

```

```{r PNEC plot}
#dx5 <- as.numeric(dx5$limit)

rfe <- subset(dx5, group=="PBDE")

dx5$Group <- revalue(dx5$Group, c("UV Stabilizer"="UV"))
kug <- subset(dx5, Group == "Other")

pnecopp <- ggplot(dx5, aes(y=fct_rev(compound), x=value, xmin = Min, xmax=Max, colour = sample_category))+ 
  geom_linerange(aes(colour = sample_category, alpha=1), linewidth=2.5, position = position_dodge2(width = 0.7))+
  geom_point(aes(x=(limit), fill = sample_category),  size=6, shape=18, position = position_dodge2(width = 0.7))+
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1,vjust=1,size = 15,colour="black"),
        axis.text.y = element_text(size = 15,colour="black"),
        axis.title.y = element_blank(),
        axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0), size=17),
        panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text.y = element_text(size = 16, angle = 0, hjust=0),
        legend.title = element_blank(),
        legend.text = element_text(size=18),
        plot.margin = margin(0.8, 0.15, 1.2, 0.15, "cm"),
        legend.position = "top")+
  facet_grid(Group~., scales="free_y", space='free')+
  scale_x_continuous(trans='log10') +  
  xlab("log10(concentration)")+
  scale_alpha(guide = 'none')+
  guides(color=guide_legend("sample_category"), fill = "none")+
  scale_color_manual(values = c("#C77CFF", "#00BFC4", "#7CAE00"),
  labels = c('Marine biota', 'Freshwater', 'Sediment'))
  


ggsave("pnec23.png", pnecopp, width = 10, height = 18)

#, values = c("red", "blue", "grey"))
#  scale_colour_manual(labels = c("Biota", "Freshwater", "Sediment"), values = c("red", "blue", "grey"))
  
  #scale_fill_manual(values = c("red", "blue", "grey"))
  #scale_colour_manual(values = c("red", "blue", "grey"))


```
